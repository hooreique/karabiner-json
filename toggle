#!/usr/bin/swift

import Carbon

let abc = "com.apple.keylayout.ABC"
let kor = "com.apple.inputmethod.Korean.2SetKorean"

if let currSource = TISCopyCurrentKeyboardInputSource()?.takeUnretainedValue()
 , let currId = TISGetInputSourceProperty(currSource, kTISPropertyInputSourceID)
{
  let curr = Unmanaged<CFString>.fromOpaque(currId).takeUnretainedValue() as String

  let next = (curr == abc) ? kor : abc

  let sources = TISCreateInputSourceList(nil, false)?.takeRetainedValue() as! [TISInputSource]

  for source in sources {
    if let id = TISGetInputSourceProperty(source, kTISPropertyInputSourceID) {
      let str = Unmanaged<CFString>.fromOpaque(id).takeUnretainedValue() as String

      if str == next {
        TISSelectInputSource(source)
        break
      }
    }
  }
}
